# 講師割り当てシステム 仕様概要

## 1. システム目的
本システムは、OR-Tools (CP-SAT ソルバー) を利用して、講師を各講座へ最適に割り当てることを目的としたプロトタイプです。
様々な制約条件と最適化目標を考慮し、最適な割り当て計画を自動生成します。

## 2. 主要機能
- **講師と講座の自動割り当て**: 定義された制約と目的に基づき、最適な講師と講座のペアを探索します。
- **動的なデータ生成**: デモンストレーション用に、講師、講座、教室、移動コストなどのサンプルデータを自動生成します。
- **最適化目標の重み設定**: UIを通じて、各最適化目標（コスト最小化、公平性など）の重要度を調整できます。
- **ログ出力と解説**:
    - ソルバーの実行ログをダウンロード可能です。
    - Gemini API と連携し、ソルバーログと本仕様を基に、最適化プロセスや結果について平易な解説を生成します。

## 3. データ定義
### 3.1. 講師 (Lecturers)
- **ID**: 一意な識別子
- **氏名**: 講師名
- **年齢**: 年齢
- **自宅教室ID**: 最も近い教室のID
- **資格ランク**:
    - **一般資格ランク**: 1 (高) - 5 (低)
    - **特別資格ランク**: 1 (高) - 5 (低)。持たない場合は `None`。特別資格を持つ講師は一般資格ランク1として扱われます。
- **対応可能日**: 講師が勤務可能な日付のリスト (YYYY-MM-DD形式)
- **過去の割り当て履歴**: 過去に担当した講座の教室IDと日付のリスト

### 3.2. 講座 (Courses)
- **ID**: 一意な識別子
- **講座名**: 講座の名称
- **教室ID**: 開催される教室のID
- **講座タイプ**: "general" (一般講座) または "special" (特別講座)
- **要求ランク**: 1 (高) - 5 (低)。このランク以上の資格を持つ講師が担当可能。
- **スケジュール**: 開催日 (YYYY-MM-DD形式)

### 3.3. 教室 (Classrooms)
- **ID**: 一意な識別子
- **場所**: 都道府県名

### 3.4. 移動コスト (Travel Costs)
- 講師の自宅教室から各講座開催教室への移動コスト。同一地域内、隣接地域間、遠隔地域間、沖縄関連でコストが変動します。

## 4. 最適化ロジック (CP-SAT ソルバー)
### 4.1. 決定変数
- $x_{l,c}$: 講師 $l$ が講座 $c$ に割り当てられるか (0 or 1)
- $y_{l,p}$: 特別資格を持つ講師 $l$ が連日講座ペア $p$ をまとめて担当するか (0 or 1)
- その他、割り当て不足数や講師の集中度合いを示す補助変数

### 4.2. 制約条件 (ハード制約 - 必ず守るルール)
1.  **資格**: 講師は、担当する講座の要求ランク以上の資格（一般講座は一般資格or特別資格、特別講座は特別資格）を保有している必要があります。
2.  **スケジュール**: 講師は、自身の対応可能日に開催される講座のみ担当可能です。
3.  **講座ごとの割り当て人数**:
    - 東京都、愛知県、大阪府の教室で開催される講座: 原則2名
    - その他の教室で開催される講座: 原則1名
    (UIの「許容条件」で割り当て不足を許容するか設定可能)

### 4.3. 最適化目標 (目的関数で最小化/最大化する項目)
以下の各項目について、UIで設定された重みに基づき、総合的なコスト（または報酬）を計算し、その総和を最小化します。報酬は負のコストとして扱います。

1.  **移動コスト最小化**: 講師の自宅教室から講座開催地までの移動コストが小さい割り当てを優先します。
2.  **若手講師優先**: 年齢が若い講師の割り当てを優先します。
3.  **割り当て頻度平準化**: 過去の総割り当て回数が少ない講師の割り当てを優先します。
4.  **高資格講師優先**: より高い資格ランクを持つ講師の割り当てを優先します。
5.  **同一教室への未経験者/久しぶりの講師優先**:
    講座が開催される教室での割り当て経験がない、または最後に割り当てられてからの期間が長い講師を優先します (コストは経過日数の逆数に比例)。
6.  **割り当て不足最小化 (ペナルティ)**:
    「許容条件」で割り当て不足を許容する場合、各講座の目標割り当て人数に対する不足数にペナルティを科し、不足を減らそうとします。
7.  **講師の割り当て集中度低減 (ペナルティ)**:
    一人の講師が今回の最適化で担当する講座数が1を超える場合、その超過分に対してペナルティを科し、割り当ての集中を避けます。
8.  **連日講座への連続割り当て (報酬)**:
    特別資格を持つ講師が、同一教室で開催される一般講座とその翌日の特別講座（またはその逆）のペアをまとめて担当する場合に報酬を与え、連続割り当てを奨励します。

## 5. ログの解釈について
ソルバーログには以下の情報が含まれます。
- **Presolve**: 問題の事前処理ステップとモデルの簡略化状況。
- **Search progress**: 解の探索過程。`#1`, `#2`... は新しい解が見つかったことを示し、`best` はその時点での目的関数値です。
- **Statistics**: 各探索戦略の実行時間や効果などの統計情報。
- **CpSolverResponse summary**: 最終的な解のステータス (OPTIMAL, FEASIBLE, INFEASIBLEなど)、目的関数値、計算時間。

この仕様概要とソルバーログを照らし合わせることで、最適化がどのように行われ、なぜ特定の結果になったのかを理解する助けとなります。